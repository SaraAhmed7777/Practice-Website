<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Find a Volunteer Project | CUNYServe</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="font-sans text-gray-800 bg-gray-100">
  <!-- Navbar -->
  <div id="navbar-placeholder"></div>

  <!-- Hero -->
  <section class="bg-[#0056b3] text-white text-center py-10 px-4">
    <h1 class="text-3xl font-bold mb-2">Find a Volunteer Project</h1>
    <p class="text-lg">Long-term or recurring opportunities—CUNY & non-CUNY.</p>
  </section>

  <!-- Filters -->
  <section class="bg-white py-6">
    <div class="max-w-6xl mx-auto px-4 flex flex-wrap gap-4 items-center justify-between">
      <input id="searchInput" type="text" placeholder="Search titles or tags…" class="w-full md:w-1/3 px-4 py-2 border rounded" />
      <select id="campusFilter" class="w-full md:w-1/4 px-4 py-2 border rounded">
        <option value="All">All Campuses</option>
        <!-- campuses appended via JS -->
      </select>
      <select id="typeFilter" class="w-full md:w-1/4 px-4 py-2 border rounded">
        <option value="All">All Types</option>
        <option value="Mentoring">Mentoring</option>
        <option value="Campus Volunteering">Campus Volunteering</option>
        <option value="Community Support">Community Support</option>
        <option value="Education">Education</option>
        <option value="Animal Welfare">Animal Welfare</option>
        <option value="Skills-Based">Skills-Based</option>
        <option value="Civic Action">Civic Action</option>
        <option value="Health Support">Health Support</option>
        <option value="Disaster Response">Disaster Response</option>
        <option value="International Volunteering">International Volunteering</option>
        <option value="Digital Volunteering">Digital Volunteering</option>
        <option value="Translation">Translation</option>
        <option value="Service Program">Service Program</option>
        <option value="Logistics">Logistics</option>
      </select>
      <select id="formatFilter" class="w-full md:w-1/4 px-4 py-2 border rounded">
        <option value="All">All Formats</option>
        <option value="In-Person">In-Person</option>
        <option value="Remote">Remote</option>
        <option value="Hybrid">Hybrid</option>
        <option value="Virtual">Virtual</option>
      </select>
    </div>
    <p id="projectCount" class="max-w-6xl mx-auto px-4 mt-2 text-sm text-gray-600"></p>
  </section>

  <!-- Projects Grid -->
  <section class="bg-gray-50 py-10">
    <div id="projectGrid" class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 px-4"></div>
  </section>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="bg-white shadow-lg border rounded-xl px-4 py-3 text-sm">
      <span id="toastMsg">Saved!</span>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-900 text-gray-300 py-8">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center text-sm px-4">
      <p>&copy; 2025 CUNYServe. All rights reserved.</p>
      <div class="space-x-4 mt-4 md:mt-0">
        <a href="#" class="hover:text-white">Privacy</a>
        <a href="#" class="hover:text-white">Terms</a>
        <a href="#" class="hover:text-white">Contact</a>
      </div>
    </div>
  </footer>

  <!-- Script -->
<script>
/* ---------- campus constants + normalization ---------- */

// canonical list (25 CUNY + Non-CUNY)
const CAMPUS_LIST = [
  "Baruch College","Brooklyn College","City College of New York (CCNY)","Hunter College","John Jay College of Criminal Justice",
  "Lehman College","Medgar Evers College","Queens College","College of Staten Island (CSI)","York College",
  "New York City College of Technology (City Tech)","Macaulay Honors College","CUNY School of Professional Studies (CUNY SPS)",
  "CUNY School of Labor and Urban Studies (CUNY SLU)","CUNY School of Law","The Graduate Center, CUNY",
  "Craig Newmark Graduate School of Journalism","CUNY Graduate School of Public Health & Health Policy (CUNY SPH)",
  "Borough of Manhattan Community College (BMCC)","Bronx Community College","Guttman Community College","Hostos Community College",
  "Kingsborough Community College","LaGuardia Community College","Queensborough Community College","Non-CUNY"
];

// map common short names/aliases -> canonical
const CAMPUS_ALIASES = {
  "BMCC": "Borough of Manhattan Community College (BMCC)",
  "City College": "City College of New York (CCNY)",
  "CCNY": "City College of New York (CCNY)",
  "CSI": "College of Staten Island (CSI)",
  "City Tech": "New York City College of Technology (City Tech)",
  "SPS": "CUNY School of Professional Studies (CUNY SPS)",
  "SLU": "CUNY School of Labor and Urban Studies (CUNY SLU)",
  "SPH": "CUNY Graduate School of Public Health & Health Policy (CUNY SPH)",
  "Graduate Center": "The Graduate Center, CUNY",
  "Journalism School": "Craig Newmark Graduate School of Journalism",
  "Queensborough": "Queensborough Community College",
  "Kingsborough": "Kingsborough Community College",
  "Hostos": "Hostos Community College",
  "LaGuardia": "LaGuardia Community College",
  "Bronx CC": "Bronx Community College",
  "Non CUNY": "Non-CUNY",
  "Non-CUNY": "Non-CUNY"
};

function normalizeCampus(raw) {
  const v = (raw || "").trim();
  if (CAMPUS_ALIASES[v]) return CAMPUS_ALIASES[v];
  // if already canonical, return as-is
  if (CAMPUS_LIST.includes(v)) return v;
  // some entries like "Baruch College" are already canonical
  // fallback: return original so we at least display something
  return v;
}

function populateCampusFilter() {
  const sel = document.getElementById("campusFilter");
  // keep existing "All" option, then append
  CAMPUS_LIST.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
}

/* ---------- auth + ui helpers ---------- */

function isLoggedIn() {
  // frontend-only stub. set localStorage.setItem('authToken','1') to simulate login
  return !!window.isAuthenticated || !!localStorage.getItem("authToken");
}

function showToast(message = "Saved!") {
  const toast = document.getElementById("toast");
  const toastMsg = document.getElementById("toastMsg");
  toastMsg.textContent = message;
  toast.classList.remove("hidden");
  setTimeout(() => toast.classList.add("hidden"), 1400);
}

function badge(text) {
  return `<span class="text-xs px-2 py-1 rounded-full bg-gray-100 border">${text}</span>`;
}

/* ---------- local signup store (swap with backend later) ---------- */

const SIGNUPS_KEY = "cunyserve_project_signups";
function hasSignup(id) {
  const list = JSON.parse(localStorage.getItem(SIGNUPS_KEY) || "[]");
  return list.includes(id);
}
async function saveSignup(id) {
  const list = JSON.parse(localStorage.getItem(SIGNUPS_KEY) || "[]");
  if (!list.includes(id)) list.push(id);
  localStorage.setItem(SIGNUPS_KEY, JSON.stringify(list));
  return { ok: true };
}

/* ---------- data + render ---------- */

let projects = [];
const projectGrid = document.getElementById("projectGrid");
const countEl = document.getElementById("projectCount");

async function loadProjects() {
  try {
    const res = await fetch('data/projects.json?cb=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status + ' loading data/projects.json');
    const raw = await res.json();

    // normalize campus names on load so filtering is consistent
    projects = (raw || []).map(p => ({
      ...p,
      campus: normalizeCampus(p.campus || "")
    }));

    renderProjects();
  } catch (err) {
    console.error(err);
    projectGrid.innerHTML = `
      <div class="bg-red-50 text-red-700 p-4 rounded">
        Could not load <code>data/projects.json</code>.
        Open <a class="underline" href="data/projects.json" target="_blank">data/projects.json</a> to verify.
      </div>`;
  }
}

function normalizeExternalUrl(p) {
  // prefer explicit externalUrl; fallback to legacy applyUrl
  return p.externalUrl || p.applyUrl || "";
}

function renderProjects() {
  const term   = (document.getElementById("searchInput")?.value || "").toLowerCase().trim();
  const format = document.getElementById("formatFilter")?.value || "All";
  const campusSelected = document.getElementById("campusFilter")?.value || "All";
  const type   = document.getElementById("typeFilter")?.value || "All";

  const filtered = projects.filter(p => {
    const pCampus = normalizeCampus(p.campus);
    const campusMatch = (campusSelected === "All") || (pCampus === campusSelected);

    return campusMatch &&
           (format === "All"  || p.format === format) &&
           (type   === "All"  || p.type   === type) &&
           (!term || p.title.toLowerCase().includes(term) || (p.tags || []).join(" ").toLowerCase().includes(term));
  });

  if (countEl) countEl.textContent = `Showing ${filtered.length} project${filtered.length !== 1 ? 's' : ''}`;

  if (filtered.length === 0) {
    projectGrid.innerHTML = "<div class='text-center text-gray-500 italic'>No projects match your filters.</div>";
    return;
  }

  projectGrid.innerHTML = filtered.map(p => {
    const id = p.id || p.title; // if your JSON lacks id, fallback to title
    const tags = (p.tags || []).slice(0, 6).map(t => badge(t)).join(" ");
    const extUrl = normalizeExternalUrl(p);
    const signed = hasSignup(id);

    const btnLabel = signed ? "Signed up" : "Sign up";
    const btnCls = signed ? "bg-gray-200 text-gray-500 cursor-default"
                          : "bg-[#0056b3] text-white hover:bg-[#0a4b95]";

    return `
      <div class="bg-white rounded-2xl p-5 shadow w-full max-w-sm">
        <div class="text-sm text-gray-500">${p.org || ""}</div>
        <h3 class="text-xl font-semibold text-[#0056b3] mt-1">${p.title}</h3>

        <div class="mt-2 flex flex-wrap gap-2">
          ${badge(normalizeCampus(p.campus) || "—")}
          ${badge(p.format || "—")}
          ${p.type ? badge(p.type) : ""}
          ${p.location ? badge(p.location) : ""}
        </div>

        <p class="text-gray-600 mt-3">${p.description || p.desc || ""}</p>
        <div class="mt-3 flex flex-wrap gap-2">${tags}</div>

        <a href="#"
           data-project-id="${id}"
           data-external-url="${extUrl}"
           data-requires-login="true"
           class="mt-4 inline-flex items-center justify-center px-3 py-2 rounded-xl text-sm font-medium ${btnCls}">
          ${btnLabel}
        </a>
      </div>`;
  }).join("");

  // click handler: save locally first, then maybe open external
  projectGrid.querySelectorAll('a[data-project-id]').forEach(a => {
    a.addEventListener('click', async (ev) => {
      ev.preventDefault(); // never navigate first
      const el = ev.currentTarget;
      const id = el.getAttribute('data-project-id');
      const extUrl = el.getAttribute('data-external-url');
      const requiresLogin = el.getAttribute('data-requires-login') === 'true';

      if (hasSignup(id)) return; // already signed

      if (requiresLogin && !isLoggedIn()) {
        alert("Please log in to sign up.");
        // location.href = "login.html?next=volunteer-projects.html"; // when ready
        return;
      }

      try {
        el.classList.add('opacity-70','pointer-events-none');
        el.textContent = 'Saving...';

        await saveSignup(id);

        el.textContent = 'Signed up';
        el.classList.remove('opacity-70','pointer-events-none');
        el.classList.add('bg-gray-200','text-gray-500','cursor-default');
        el.classList.remove('bg-[#0056b3]','hover:bg-[#0a4b95]','text-white');

        showToast('Signup saved!');
        if (extUrl) window.open(extUrl, "_blank", "noopener");
      } catch (e) {
        console.error(e);
        alert('Something went wrong saving your signup.');
        el.textContent = 'Sign up';
        el.classList.remove('opacity-70','pointer-events-none');
      }
    });
  });
}

/* ---------- filter events ---------- */
document.getElementById("formatFilter")?.addEventListener("change", renderProjects);
document.getElementById("campusFilter")?.addEventListener("change", renderProjects);
document.getElementById("typeFilter")?.addEventListener("change", renderProjects);
document.getElementById("searchInput")?.addEventListener("input", renderProjects);

/* ---------- boot ---------- */
populateCampusFilter();
loadProjects();
</script>

  <script src="navbar.js"></script>
</body>
</html>
