
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Events | CUNYServe</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="font-sans text-gray-800 bg-gray-100">
  <!-- Navbar loads in from navbar.js -->
  <div id="navbar-placeholder"></div>

  <!-- Top banner -->
  <section class="bg-[#0056b3] text-white text-center py-10 px-4">
    <h2 class="text-3xl font-bold mb-2">Upcoming Volunteer Events</h2>
    <p class="text-lg">Explore civic engagement opportunities across all CUNY campuses and NYC.</p>
  </section>

  <!-- Filter dropdowns -->
  <div class="flex flex-wrap justify-center gap-4 my-6 px-4">
    <select id="campusFilter" class="p-2 rounded border">
      <option value="All">All Campuses</option>
      <option value="Baruch College">Baruch College</option>
      <option value="Queens College">Queens College</option>
      <option value="City College">City College</option>
      <option value="Hunter College">Hunter College</option>
      <option value="Brooklyn College">Brooklyn College</option>
      <option value="BMCC">BMCC</option>
      <option value="CSI">CSI</option>
      <option value="Non-CUNY">Non-CUNY</option>
    </select>
    <select id="typeFilter" class="p-2 rounded border">
      <option value="All">All Types</option>
      <option value="Clean-Up">Clean-Up</option>
      <option value="Tutoring">Tutoring</option>
      <option value="Food Pantry">Food Pantry</option>
      <option value="Donation Drive">Donation Drive</option>
      <option value="Registration Drive">Registration Drive</option>
      <option value="Mentorship">Mentorship</option>
    </select>
    <select id="formatFilter" class="p-2 rounded border">
      <option value="All">All Formats</option>
      <option value="In-Person">In-Person</option>
      <option value="Virtual">Virtual</option>
    </select>
  </div>

  <!-- Events list goes here -->
  <div id="eventGrid" class="flex flex-wrap justify-center gap-6 px-4 pb-10"></div>

  <!-- Small popup when RSVP is saved -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="bg-white shadow-lg border rounded-xl px-4 py-3 text-sm">
      <span id="toastMsg">Saved!</span>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white text-center py-4 mt-8">
    <p>© 2025 CUNYServe. All rights reserved.</p>
    <div class="mt-2">
      <a href="#" class="mx-2 hover:underline">Privacy</a>
      <a href="#" class="mx-2 hover:underline">Terms</a>
      <a href="#" class="mx-2 hover:underline">Contact</a>
    </div>
  </footer>

  <!-- Events Script -->
  <script>
/**
 * =========================
 * NOTES FOR ME / MY TEAM:
 * =========================
 * - This is only frontend. It loads events.json and shows the cards.
 * - When I click "Sign up", it just saves the RSVP in localStorage for now.
 * - Later on, my teammate can hook it up to the backend (look for BACKEND_TODO comments).
 */

let events = [];
const eventGrid = document.getElementById("eventGrid");
const toast = document.getElementById("toast");
const toastMsg = document.getElementById("toastMsg");

// Check if the user is logged in
// (Right now just checks if authToken is in localStorage or a global flag is set)
// BACKEND_TODO: update this to match real auth later
function isLoggedIn() {
  return !!window.isAuthenticated || !!localStorage.getItem("authToken");
}

// Save RSVP (for now just in localStorage)
// BACKEND_TODO: later change this to call the real backend API
async function saveRsvp(eventId) {
  const key = "cunyserve_rsvps";
  const list = JSON.parse(localStorage.getItem(key) || "[]");
  if (!list.includes(eventId)) list.push(eventId);
  localStorage.setItem(key, JSON.stringify(list));
  return Promise.resolve({ ok: true }); // fake a "success" response
}

// Check if user already RSVP’d
function hasRsvp(eventId) {
  const key = "cunyserve_rsvps";
  const list = JSON.parse(localStorage.getItem(key) || "[]");
  return list.includes(eventId);
}

// Show quick popup message (toast)
function showToast(message = "Saved!") {
  toastMsg.textContent = message;
  toast.classList.remove("hidden");
  setTimeout(() => toast.classList.add("hidden"), 1400);
}

// Format date to something nicer
function formatDate(iso) {
  if (!iso) return "";
  const d = new Date(iso + "T00:00:00");
  return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
}

// Load events.json file
async function loadEvents() {
  try {
    // IMPORTANT: no leading slash, works better on GitHub Pages
    const res = await fetch('data/events.json?cb=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    events = await res.json();

    // Sort events by date
    events.sort((a,b) => (new Date(a.date || '9999-12-31')) - (new Date(b.date || '9999-12-31')));
    renderEvents();
  } catch (err) {
    console.error(err);
    eventGrid.innerHTML = `
      <div class="bg-red-50 text-red-700 p-4 rounded max-w-xl">
        Could not load <code>data/events.json</code>.
        <a class="underline" href="data/events.json" target="_blank">Check events.json</a>
      </div>`;
  }
}

// Badge component (small tags)
function badge(text, extra="") {
  return \`<span class="inline-block text-xs px-2 py-1 rounded-full bg-gray-100 border \${extra}">\${text}</span>\`;
}

// Render events list
function renderEvents() {
  const campus = document.getElementById("campusFilter").value;
  const type = document.getElementById("typeFilter").value;
  const format = document.getElementById("formatFilter").value;

  const filtered = events.filter(e =>
    (campus === "All" || e.campus === campus) &&
    (type === "All" || e.type === type) &&
    (format === "All" || e.format === format)
  );

  if (filtered.length === 0) {
    eventGrid.innerHTML = "<div class='text-center text-gray-500 italic'>No events match your filters.</div>";
    return;
  }

  eventGrid.innerHTML = filtered.map(e => {
    const dateText = formatDate(e.date);
    const timeText = [e.startTime, e.endTime].filter(Boolean).join(" – ");
    const desc = e.desc || e.description || "";

    const isClosed = e.rsvpOpen === false;
    const needsLogin = e.requiresLogin === true;
    const isExternal = e.external === true && e.externalUrl;

    const statusBadge = isClosed
      ? badge("Closed", "border-red-300 bg-red-50 text-red-700")
      : badge("Open", "border-green-300 bg-green-50 text-green-700");

    const externalBadge = isExternal ? badge("External signup", "border-blue-300 bg-blue-50 text-blue-700") : "";
    const reqLoginBadge = needsLogin ? badge("Login required", "border-amber-300 bg-amber-50 text-amber-700") : "";
    const alreadyRsvped = hasRsvp(e.id) ? badge("You're signed up", "border-emerald-300 bg-emerald-50 text-emerald-700") : "";

    // Where button should point to
    const signupHref = e.signupUrl || ("signup.html?eventId=" + encodeURIComponent(e.id));
    const disabledAttrs = isClosed ? 'aria-disabled="true"' : '';

    const btn = `
      <a href="${signupHref}"
         data-event-id="${e.id}"
         class="mt-4 inline-flex items-center justify-center px-3 py-2 rounded-xl text-sm font-medium
                ${isClosed ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-[#0056b3] text-white hover:bg-[#0a4b95]'}
         "
         ${disabledAttrs}
      >${isClosed ? 'RSVP Closed' : (hasRsvp(e.id) ? 'Signed up' : 'Sign up')}</a>`;

    return `
      <div class="bg-white rounded-2xl p-5 shadow w-full max-w-sm">
        <h3 class="text-xl font-semibold text-[#0056b3] mb-2">${e.title}</h3>

        <div class="flex flex-wrap gap-2 mb-3">
          ${statusBadge}
          ${externalBadge}
          ${reqLoginBadge}
          ${alreadyRsvped}
          ${badge(e.campus)}
          ${badge(e.format)}
          ${e.type ? badge(e.type) : ""}
          ${(e.tags || []).slice(0,3).map(t => badge("#" + t)).join("")}
        </div>

        <p class="text-sm text-gray-700 mb-2">
          <strong>${dateText}${timeText ? " • " + timeText : ""}</strong>
        </p>
        <p class="text-gray-600 min-h-12">${desc}</p>

        ${btn}
      </div>`;
  }).join("");

  // Button click handler
  eventGrid.querySelectorAll('a[data-event-id]').forEach(a => {
    a.addEventListener('click', async (ev) => {
      const el = ev.currentTarget;
      const eventId = el.getAttribute('data-event-id');

      if (el.getAttribute('aria-disabled') === 'true') {
        ev.preventDefault();
        return;
      }

      const evt = events.find(x => x.id === eventId);
      const needsLogin = evt?.requiresLogin === true;

      // If login required but user not logged in → send them to login page
      if (needsLogin && !isLoggedIn()) {
        ev.preventDefault();
        const returnTo = location.pathname + location.search + location.hash;
        location.href = \`login.html?next=events.html&eventId=\${encodeURIComponent(eventId)}&returnTo=\${encodeURIComponent(returnTo)}\`;
        return;
      }

      // RSVP logic (frontend only)
      ev.preventDefault();
      try {
        el.classList.add('opacity-70','pointer-events-none');
        el.textContent = 'Saving...';

        await saveRsvp(eventId);
        showToast('RSVP saved!');
        el.textContent = 'Signed up';

        // If this is an external event, redirect out
        if (evt && evt.external === true && evt.externalUrl) {
          window.location.href = evt.externalUrl;
        } else {
          // stay on page (or later go to confirmation page if we add one)
          el.classList.remove('opacity-70','pointer-events-none');
        }
      } catch (e) {
        console.error(e);
        alert('Something went wrong saving your RSVP.');
        el.textContent = hasRsvp(eventId) ? 'Signed up' : 'Sign up';
        el.classList.remove('opacity-70','pointer-events-none');
      }
    });
  });
}

// re-render when filters change
document.getElementById("campusFilter").addEventListener("change", renderEvents);
document.getElementById("typeFilter").addEventListener("change", renderEvents);
document.getElementById("formatFilter").addEventListener("change", renderEvents);

// start everything
loadEvents();
</script>

  <script src="navbar.js"></script>
</body>
</html>
