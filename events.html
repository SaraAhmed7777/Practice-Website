<!-- filename: events.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Events | CUNYServe</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="font-sans text-gray-800 bg-gray-100">
  <!-- navbar loads from navbar.js -->
  <div id="navbar-placeholder"></div>

  <!-- top banner -->
  <section class="bg-[#0056b3] text-white text-center py-10 px-4">
    <h2 class="text-3xl font-bold mb-2">Upcoming Volunteer Events</h2>
    <p class="text-lg">Explore civic engagement opportunities across all CUNY campuses and NYC.</p>
  </section>

  <!-- filters -->
  <div class="flex flex-wrap justify-center gap-4 my-6 px-4">
    <!-- campus dropdown gets filled at runtime so we always have the full set -->
    <select id="campusFilter" class="p-2 rounded border">
      <option value="All">All Campuses</option>
      <!-- options injected by JS -->
    </select>

    <select id="typeFilter" class="p-2 rounded border">
      <option value="All">All Types</option>
      <option value="Clean-Up">Clean-Up</option>
      <option value="Tutoring">Tutoring</option>
      <option value="Food Pantry">Food Pantry</option>
      <option value="Donation Drive">Donation Drive</option>
      <option value="Registration Drive">Registration Drive</option>
      <option value="Mentorship">Mentorship</option>
    </select>

    <select id="formatFilter" class="p-2 rounded border">
      <option value="All">All Formats</option>
      <option value="In-Person">In-Person</option>
      <option value="Virtual">Virtual</option>
    </select>
  </div>

  <!-- events grid -->
  <div id="eventGrid" class="flex flex-wrap justify-center gap-6 px-4 pb-10"></div>

  <!-- quick toast when RSVP is saved -->
  <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="bg-white shadow-lg border rounded-xl px-4 py-3 text-sm">
      <span id="toastMsg">Saved!</span>
    </div>
  </div>

  <!-- footer -->
  <footer class="bg-gray-900 text-white text-center py-4 mt-8">
    <p>© 2025 CUNYServe. All rights reserved.</p>
    <div class="mt-2">
      <a href="#" class="mx-2 hover:underline">Privacy</a>
      <a href="#" class="mx-2 hover:underline">Terms</a>
      <a href="#" class="mx-2 hover:underline">Contact</a>
    </div>
  </footer>

  <!-- page script -->
<script>
/**
 * me -> sabbir:
 * - frontend only. loads events list and renders.
 * - Sign up saves locally first; if event.external === true, we then open externalUrl.
 * - Later, replace saveRsvp() with a real POST and keep the rest.
 */

let events = [];
const eventGrid = document.getElementById("eventGrid");
const toast = document.getElementById("toast");
const toastMsg = document.getElementById("toastMsg");

/* FULL campus list for filter (25 + Non-CUNY) */
const CUNY_CAMPUSES = [
  "Baruch College","Brooklyn College","City College of New York (CCNY)","Hunter College","John Jay College of Criminal Justice",
  "Lehman College","Medgar Evers College","Queens College","College of Staten Island (CSI)","York College",
  "New York City College of Technology (City Tech)","Macaulay Honors College","CUNY School of Professional Studies (CUNY SPS)",
  "CUNY School of Labor and Urban Studies (CUNY SLU)","CUNY School of Law","The Graduate Center, CUNY",
  "Craig Newmark Graduate School of Journalism","CUNY Graduate School of Public Health & Health Policy (CUNY SPH)",
  "Borough of Manhattan Community College (BMCC)","Bronx Community College","Guttman Community College","Hostos Community College",
  "Kingsborough Community College","LaGuardia Community College","Queensborough Community College","Non-CUNY"
];

function populateCampusFilter() {
  const sel = document.getElementById("campusFilter");
  // keep "All Campuses" then add full list
  CUNY_CAMPUSES.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
}

function isLoggedIn() {
  return !!window.isAuthenticated || !!localStorage.getItem("authToken");
}

// local RSVP store (swap with backend later)
async function saveRsvp(eventId) {
  const key = "cunyserve_rsvps";
  const list = JSON.parse(localStorage.getItem(key) || "[]");
  if (!list.includes(eventId)) list.push(eventId);
  localStorage.setItem(key, JSON.stringify(list));
  return { ok:true };
}
function hasRsvp(eventId) {
  const list = JSON.parse(localStorage.getItem("cunyserve_rsvps") || "[]");
  return list.includes(eventId);
}

function showToast(message="Saved!") {
  toastMsg.textContent = message;
  toast.classList.remove("hidden");
  setTimeout(() => toast.classList.add("hidden"), 1400);
}

function formatDate(iso) {
  if (!iso) return "";
  const d = new Date(iso + "T00:00:00");
  return d.toLocaleDateString(undefined, { month: "short", day: "numeric", year: "numeric" });
}

function badge(text, extra="") {
  return `<span class="inline-block text-xs px-2 py-1 rounded-full bg-gray-100 border ${extra}">${text}</span>`;
}

/* tolerant fetch that allows // and /* * / style comments in JSON */
async function fetchEventsTolerant(url) {
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  try {
    return await res.json(); // normal path
  } catch {
    // fallback: parse as text, strip comments + trailing junk, then JSON.parse
    let txt = await res.text();
    // remove /* block comments */ and // line comments
    txt = txt.replace(/\/\*[\s\S]*?\*\//g, '').replace(/(^|\s)\/\/.*$/gm, '');
    // remove any accidental trailing characters after the closing ]
    const endIdx = txt.lastIndexOf(']');
    if (endIdx !== -1) txt = txt.slice(0, endIdx + 1);
    return JSON.parse(txt);
  }
}

async function loadEvents() {
  try {
    // IMPORTANT: relative path for GH Pages
    events = await fetchEventsTolerant('data/events.json?cb=' + Date.now());

    // sort by date (empty dates to bottom)
    events.sort((a,b) => (new Date(a.date || '9999-12-31')) - (new Date(b.date || '9999-12-31')));
    renderEvents();
  } catch (err) {
    console.error(err);
    eventGrid.innerHTML = `
      <div class="bg-red-50 text-red-700 p-4 rounded max-w-xl">
        Could not load <code>data/events.json</code>.
        <a class="underline" href="data/events.json" target="_blank">Check events.json</a>
      </div>`;
  }
}

function renderEvents() {
  const campusSel = document.getElementById("campusFilter").value;
  const typeSel   = document.getElementById("typeFilter").value;
  const fmtSel    = document.getElementById("formatFilter").value;

  const filtered = events.filter(e =>
    (campusSel === "All" || e.campus === campusSel) &&
    (typeSel === "All"   || e.type === typeSel) &&
    (fmtSel === "All"    || e.format === fmtSel)
  );

  if (filtered.length === 0) {
    eventGrid.innerHTML = "<div class='text-center text-gray-500 italic'>No events match your filters.</div>";
    return;
  }

  eventGrid.innerHTML = filtered.map(e => {
    const dateText = formatDate(e.date);
    const timeText = [e.startTime, e.endTime].filter(Boolean).join(" – ");
    const desc = e.desc || e.description || "";

    const isClosed   = e.rsvpOpen === false;
    const needsLogin = e.requiresLogin === true;
    const isExternal = !!(e.external === true && e.externalUrl);

    const statusBadge   = isClosed ? badge("Closed", "border-red-300 bg-red-50 text-red-700")
                                   : badge("Open", "border-green-300 bg-green-50 text-green-700");
    const externalBadge = isExternal ? badge("External signup", "border-blue-300 bg-blue-50 text-blue-700") : "";
    const reqLoginBadge = needsLogin ? badge("Login required", "border-amber-300 bg-amber-50 text-amber-700") : "";
    const alreadyBadge  = hasRsvp(e.id) ? badge("You're signed up", "border-emerald-300 bg-emerald-50 text-emerald-700") : "";

    // IMPORTANT: href="#" so it NEVER navigates away by default
    const btnDisabled = isClosed;
    const btnLabel = isClosed ? "RSVP Closed" : (hasRsvp(e.id) ? "Signed up" : "Sign up");
    const btnClass = btnDisabled
      ? "bg-gray-200 text-gray-500 cursor-not-allowed"
      : "bg-[#0056b3] text-white hover:bg-[#0a4b95]";

    const btn = `
      <a href="#"
         data-event-id="${e.id}"
         data-external-url="${isExternal ? e.externalUrl : ""}"
         data-requires-login="${needsLogin ? "true" : "false"}"
         class="mt-4 inline-flex items-center justify-center px-3 py-2 rounded-xl text-sm font-medium ${btnClass}"
         ${btnDisabled ? 'aria-disabled="true"' : ''}
      >${btnLabel}</a>`;

    return `
      <div class="bg-white rounded-2xl p-5 shadow w-full max-w-sm">
        <h3 class="text-xl font-semibold text-[#0056b3] mb-2">${e.title}</h3>

        <div class="flex flex-wrap gap-2 mb-3">
          ${statusBadge}
          ${externalBadge}
          ${reqLoginBadge}
          ${alreadyBadge}
          ${badge(e.campus || "—")}
          ${badge(e.format || "—")}
          ${e.type ? badge(e.type) : ""}
          ${(e.tags || []).slice(0,3).map(t => badge(t)).join(" ")}
        </div>

        <p class="text-sm text-gray-700 mb-2">
          <strong>${dateText}${timeText ? " • " + timeText : ""}</strong>
        </p>
        <p class="text-gray-600 min-h-12">${desc}</p>

        ${btn}
      </div>`;
  }).join("");

  // click handler: save first, then maybe open external
  eventGrid.querySelectorAll('a[data-event-id]').forEach(a => {
    a.addEventListener('click', async (ev) => {
      const el = ev.currentTarget;
      const eventId = el.getAttribute('data-event-id');
      const extUrl  = el.getAttribute('data-external-url');
      const requiresLogin = el.getAttribute('data-requires-login') === 'true';

      if (el.getAttribute('aria-disabled') === 'true') {
        ev.preventDefault();
        return;
      }

      if (requiresLogin && !isLoggedIn()) {
        ev.preventDefault();
        alert("Please log in to sign up.");
        // location.href = "/login"; // when you have a real login page
        return;
      }

      ev.preventDefault(); // never leave immediately
      try {
        el.classList.add('opacity-70','pointer-events-none');
        el.textContent = 'Saving...';

        await saveRsvp(eventId);
        showToast('RSVP saved!');
        el.textContent = 'Signed up';
        el.classList.remove('opacity-70','pointer-events-none');

        if (extUrl) window.open(extUrl, "_blank", "noopener");
      } catch (e) {
        console.error(e);
        alert('Something went wrong saving your RSVP.');
        el.textContent = hasRsvp(eventId) ? 'Signed up' : 'Sign up';
        el.classList.remove('opacity-70','pointer-events-none');
      }
    });
  });
}

// filters
document.getElementById("typeFilter").addEventListener("change", renderEvents);
document.getElementById("formatFilter").addEventListener("change", renderEvents);
document.getElementById("campusFilter").addEventListener("change", renderEvents);

// boot
populateCampusFilter();
loadEvents();
</script>

  <script src="navbar.js"></script>
</body>
</html>
